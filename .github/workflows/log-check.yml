name: Log Checker CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  analyze-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test log checker script on sample log
        run: ./log_checker.sh example.log

      - name: Handle failure if errors found
        if: failure()
        run: echo "ERROR lines detected – job failed intentionally"

      - name: Handle success if no errors
        if: success()
        run: echo "No ERROR lines – job passed"

      - name: Collect and sanitize system snapshot
        if: always()
        run: |
          mkdir snapshot
          df -h > snapshot/disk.txt
          free -h > snapshot/memory.txt
          uname -a > snapshot/kernel.txt
          hostname > snapshot/hostname.txt
          ip route > snapshot/routes.txt
          # Sanitize sensitive data (IPs, hostnames, routes)
          sed -i 's/\b([0-9]{1,3}\.){3}[0-9]{1,3}\b/[REDACTED_IP]/g' snapshot/*.txt
          sed -i 's/hostname: .*/hostname: [REDACTED]/g' snapshot/*.txt
          sed -i 's/^. *via .*$/[REDACTED_ROUTE]/g' snapshot/routes.txt  # Redact routes

      - name: Upload sanitized snapshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanitized-system-snapshot
          path: snapshot/
  - name: Build secure Docker image
    run: docker build -t secure-log-analyzer .

  - name: Scan for vulnerabilities with Trivy
    uses: aquasecurity/trivy-action@0.16.1
    with:
      image-ref: 'secure-log-analyzer'
      format: 'table'
      exit-code: '1'
      ignore-unfixed: 'true'
      severity: 'HIGH,CRITICAL'
